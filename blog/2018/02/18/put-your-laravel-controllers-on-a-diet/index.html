<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="php,laravel"><link rel="amphtml" href="https://matthewdaly.co.uk/blog/2018/02/18/put-your-laravel-controllers-on-a-diet/amp/"><meta http-equiv="Content-Security-Policy" content="default-src 'self'; child-src 'none'; frame-src disqus.com *.addthis.com; object-src 'none'; font-src 'self' fonts.google-apis.com fonts.gstatic.com; style-src 'self' fonts.googleapis.com *.addthis.com google-analytics.com *.disquscdn.com *.disqus.com 'unsafe-inline'; script-src 'self' localhost:* *.addthis.com *.google-analytics.com *.disquscdn.com *.disqus.com disqus.com *.addthisedge.com graph.facebook.com 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws://localhost:*; img-src 'self' *.google-analytics.com *.disquscdn.com *.disqus.com stats.g.doubleclick.net"><link rel="canonical" href="https://matthewdaly.co.uk/blog/2018/02/18/put-your-laravel-controllers-on-a-diet/"><link href="/opensearch.xml" rel="search" title="Matthew Daly's Blog Search" type="application/opensearchdescription+xml"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=PT+Serif" media="all"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><link rel="pingback" href="https://webmention.io/matthewdaly.co.uk/xmlrpc"><link rel="webmention" href="https://webmention.io/matthewdaly.co.uk/webmention"><title>Put Your Laravel Controllers on a Diet - Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-inverse navbar-static-top"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-nav"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="header-nav"><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href="/blog/archives/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="/rss.xml">RSS</a></li></ul><form action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded" class="navbar-form navbar-right"><div class="form-group"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input id="search" type="search" name="q" placeholder="Search..." maxlength="200" autocomplete="off" class="form-control"><ul class="searchresults"></ul></div></form></div></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">18th February 2018 6:10 pm</p><h1>Put Your Laravel Controllers on a Diet</h1><p>MVC frameworks are a tremendously useful tool for modern web development. They offer easy ways to carry out common tasks, and enforce a certain amount of structure on a project.</p><p>However, that doesn’t mean using them makes you immune to bad practices, and it’s quite easy to wind up falling into certain anti-patterns. Probably the most common is the Fat Controller.</p><h2 id="what-is-a-fat-controller-">What is a fat controller?</h2><p>When I first started out doing professional web development, CodeIgniter 2 was the first MVC framework I used. While I hadn’t used it before, I was familiar with the general concept of MVC. However, I didn’t appreciate that when referring to the model layer as a place for business logic, that wasn’t necessarily the same thing as the database models.</p><p>As such, my controllers became a dumping ground for anything that didn’t fit into the models. If it didn’t interact with the database, I put it in the controller. They quickly became bloated, with many methods running to hundreds of lines of code. The code base became hard to understand, and when I was under the gun on projects I found myself copying and pasting functionality between controllers, making the situation even worse. Not having an experienced senior developer on hand to offer criticism and advice, it was a long time before I realised that this was a problem or how to avoid it.</p><h2 id="why-are-fat-controllers-bad-">Why are fat controllers bad?</h2><p>Controllers are meant to be simple glue code that receives requests and returns responses. Anything else should be handed off to the model layer. As noted above, however, that’s not the same as putting it in the models. Your model layer can consist of many different classes, not just your Eloquent models, and you should not fall into the trap of thinking your application should consist of little more than models, views and controllers.</p><p>Placing business logic in controllers can be bad for many reasons:</p><ul><li>Code in controllers can be difficult to write automated tests for</li><li>Any logic in a controller method may need to be repeated elsewhere if the same functionality is needed for a different route, unless it’s in a private or protected method that is called from elsewhere, in which case it’s very hard to test in isolation</li><li>Placing it in the controller makes it difficult to pull out and re-use on a different project</li><li>Making your controller methods too large makes them complex and hard to follow</li></ul><p>As a general rule of thumb, I find that 10 lines of code for any one method for a controller is where it starts getting a bit much. That said, it’s not a hard and fast rule, and for very small projects it may not be worthwhile. But if a project is large and needs to be maintained for any reasonable period of time, you should take the trouble to ensure your controllers are as skinny as is practical.</p><p>Nowadays Laravel is my go-to framework and I’ve put together a number of strategies for avoiding the fat controller anti-pattern. Here’s some examples of how I would move various parts of the application out of my controllers.</p><h2 id="validation">Validation</h2><p>Laravel has a nice, easy way of getting validation out of the controllers. Just create a custom <a href="https://laravel.com/docs/5.6/validation#form-request-validation">form request</a> for your input data, as in this example:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Requests</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Foundation</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">FormRequest</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreateRequest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">FormRequest</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Determine if the user is authorized to make this request.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> bool</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">authorize</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Get the validation rules that apply to the request.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> array</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rules</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>        <span class="hljs-keyword">return</span> [</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            <span class="hljs-string">'email'</span> =&gt; <span class="hljs-string">'required|email'</span></td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>        ];</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>}</td></tr></table></code></pre><p>Then type-hint the form request in the controller method, instead of <code>Illuminate\Http\Request</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Controllers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Http</span>\<span class="hljs-title">Requests</span>\<span class="hljs-title">CreateRequest</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HomeController</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">store</span><span class="hljs-params">(CreateRequest $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>        <span class="hljs-comment">// Process request here..</span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>}</td></tr></table></code></pre><h2 id="database-access-and-caching">Database access and caching</h2><p>For non-trivial applications I normally use <a href="/blog/2017/03/01/decorating-laravel-repositories/">decorated repositories</a> to handle caching and database access in one place. That way my caching and database layers are abstracted out into separate classes, and caching is nearly always handled seamlessly without having to do much work.</p><h2 id="complex-object-creation-logic">Complex object creation logic</h2><p>If I have a form or API endpoint that needs to:</p><ul><li>Create more than one object</li><li>Transform the incoming data in some way</li><li>Or is non-trivial in any other way</li></ul><p>I will typically pull it out into a separate persister class. First, you should create an interface for this persister class:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Persisters</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Foo</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Create a new Model</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@param</span> array $data</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     * <span class="hljs-doctag">@return</span> Model</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">(array $data)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>     * Update the given Model</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * <span class="hljs-doctag">@param</span> array $data</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     * <span class="hljs-doctag">@param</span> Model $model</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> Model</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span><span class="hljs-params">(array $data, Model $model)</span></span>;</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>}</td></tr></table></code></pre><p>Then create the persister class itself:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Persisters</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">Eloquent</span>\<span class="hljs-title">Model</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Repositories</span>\<span class="hljs-title">Foo</span> <span class="hljs-title">as</span> <span class="hljs-title">Repository</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">App</span>\<span class="hljs-title">Contracts</span>\<span class="hljs-title">Persisters</span>\<span class="hljs-title">Foo</span> <span class="hljs-title">as</span> <span class="hljs-title">FooContract</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Database</span>\<span class="hljs-title">DatabaseManager</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Carbon</span>\<span class="hljs-title">Carbon</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Foo</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">FooContract</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-keyword">protected</span> $repository;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    <span class="hljs-keyword">protected</span> $db;</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(DatabaseManager $db, Repository $repository)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db = $db;</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        <span class="hljs-keyword">$this</span>-&gt;repository = $repository;</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>     * Create a new Model</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>     * <span class="hljs-doctag">@param</span> array $data</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>     * <span class="hljs-doctag">@return</span> Model</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span><span class="hljs-params">(array $data)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db-&gt;beginTransaction();</td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>        $model = <span class="hljs-keyword">$this</span>-&gt;repository-&gt;create([</td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>             <span class="hljs-string">'date'</span> =&gt; Carbon::parse($data[<span class="hljs-string">'date'</span>])-&gt;toDayDateTimeString(),</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db-&gt;commit();</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>        <span class="hljs-keyword">return</span> $model;</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>     * Update the given Model</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="42"></td><td>     * <span class="hljs-doctag">@param</span> array $data</td></tr><tr><td class="linenos" data-pseudo-content="43"></td><td>     * <span class="hljs-doctag">@param</span> Model $model</td></tr><tr><td class="linenos" data-pseudo-content="44"></td><td>     * <span class="hljs-doctag">@return</span> Model</td></tr><tr><td class="linenos" data-pseudo-content="45"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="46"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">update</span><span class="hljs-params">(array $data, Model $model)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="47"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="48"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db-&gt;beginTransaction();</td></tr><tr><td class="linenos" data-pseudo-content="49"></td><td>        $updatedmodel = <span class="hljs-keyword">$this</span>-&gt;repository-&gt;update([</td></tr><tr><td class="linenos" data-pseudo-content="50"></td><td>             <span class="hljs-string">'date'</span> =&gt; Carbon::parse($data[<span class="hljs-string">'date'</span>])-&gt;toDayDateTimeString(),</td></tr><tr><td class="linenos" data-pseudo-content="51"></td><td>             $model</td></tr><tr><td class="linenos" data-pseudo-content="52"></td><td>        ]);</td></tr><tr><td class="linenos" data-pseudo-content="53"></td><td>        <span class="hljs-keyword">$this</span>-&gt;db-&gt;commit();</td></tr><tr><td class="linenos" data-pseudo-content="54"></td><td>        <span class="hljs-keyword">return</span> $updatedmodel;</td></tr><tr><td class="linenos" data-pseudo-content="55"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="56"></td><td>}</td></tr></table></code></pre><p>Then you can set up the persister in a service provider so that type-hinting the interface returns the persister:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Providers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">ServiceProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>     * Bootstrap any application services.</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>     * Register any application services.</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>       <span class="hljs-keyword">$this</span>-&gt;app-&gt;bind(</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            <span class="hljs-string">'App\Contracts\Persisters\Foo'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>            <span class="hljs-string">'App\Persisters\Foo'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>       });</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td>}</td></tr></table></code></pre><p>This approach means that complex logic, such as creating multiple related objects, can be handled in a consistent way, even if it needs to be called from multiple places.</p><h2 id="triggering-actions-as-a-result-of-something">Triggering actions as a result of something</h2><p><a href="https://laravel.com/docs/5.6/events">Events</a> are tailor-made for this use case, and Laravel documents them very well, so I won’t repeat it here. Suffice to say, if something needs to happen, but the response sent by the application doesn’t necessarily depend on it returning something immediately, then it’s probably worth considering making it an event. If it’s going to be called from multiple places, it’s even more worthwhile.</p><p>For instance, if you have a contact form, it’s worth taking the time to create an event for when a new contact is received, and handle proessing the contact within the listener for that event. Also, doing so means you can queue that event and have it handled outside the context of the application, so that it responds to the user more quickly. If you’re sending an acknowledgement email for a new user registration, you don’t need to wait for that email to be sent before you return the response, so queueing it can improve response times.</p><h2 id="interacting-with-third-party-services">Interacting with third-party services</h2><p>If you have some code that needs to interact with a third-party service or API, it can get quite complex, especially if you need to process the content in some way. It therefore makes sense to pull that functionality out into a separate class.</p><p>For instance, say you have some code in your controller that uses an HTTP client to fetch some data from a third-party API and display it in the view:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span><span class="hljs-params">(Request $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>   $data = <span class="hljs-keyword">$this</span>-&gt;client-&gt;get(<span class="hljs-string">'http://api.com/api/items'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>   $items = [];</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>   <span class="hljs-keyword">foreach</span> ($data <span class="hljs-keyword">as</span> $k =&gt; $v) {</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>         $item = [</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>           <span class="hljs-string">'name'</span> =&gt; $v[<span class="hljs-string">'name'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>              <span class="hljs-string">'description'</span> =&gt; $v[<span class="hljs-string">'data'</span>][<span class="hljs-string">'description'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>              <span class="hljs-string">'tags'</span> =&gt; $v[<span class="hljs-string">'data'</span>][<span class="hljs-string">'metadata'</span>][<span class="hljs-string">'tags'</span>]</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>         ];</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>         $items[] = $item;</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>   }</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>   <span class="hljs-keyword">return</span> view(<span class="hljs-string">'template'</span>, [</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>       <span class="hljs-string">'items'</span> =&gt; $items</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>   ]);</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>}</td></tr></table></code></pre><p>This is a very small example (and a lot simpler than most real-world instances of this issue), but it illustrates the principle. Not only does this code bloat the controller, it might also be used elsewhere in the application, and we don’t want to copy and paste it elsewhere - therefore it makes sense to extract it to a service class.</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Services</span></td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-title">use</span> <span class="hljs-title">GuzzleHttp</span>\<span class="hljs-title">ClientInterface</span> <span class="hljs-title">as</span> <span class="hljs-title">GuzzleClient</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Api</span></span></td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>   <span class="hljs-keyword">protected</span> $client;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>   <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(GuzzleClient $client)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>   {</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>      <span class="hljs-keyword">$this</span>-&gt;client = $client;</td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>   }</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fetch</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>      $data = <span class="hljs-keyword">$this</span>-&gt;client-&gt;get(<span class="hljs-string">'http://api.com/api/items'</span>);</td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>      $items = [];</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>      <span class="hljs-keyword">foreach</span> ($data <span class="hljs-keyword">as</span> $k =&gt; $v) {</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>         $item = [</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>            <span class="hljs-string">'name'</span> =&gt; $v[<span class="hljs-string">'name'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>            <span class="hljs-string">'description'</span> =&gt; $v[<span class="hljs-string">'data'</span>][<span class="hljs-string">'description'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>            <span class="hljs-string">'tags'</span> =&gt; $v[<span class="hljs-string">'data'</span>][<span class="hljs-string">'metadata'</span>][<span class="hljs-string">'tags'</span>]</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>         ];</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td>         $items[] = $item;</td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>      }</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>      <span class="hljs-keyword">return</span> $items;</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>}</td></tr></table></code></pre><p>Our controller can then type-hint the service and refactor that functionality out of the method:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span><span class="hljs-params">(App\Services\Api $api)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>    <span class="hljs-keyword">$this</span>-&gt;api = $api;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>}</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">index</span><span class="hljs-params">(Request $request)</span></span></td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td>   $items = <span class="hljs-keyword">$this</span>-&gt;api-&gt;fetch();</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td>   <span class="hljs-keyword">return</span> view(<span class="hljs-string">'template'</span>, [</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td>       <span class="hljs-string">'items'</span> =&gt; $items</td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td>   ]);</td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>}</td></tr></table></code></pre><h2 id="including-common-variables-in-the-view">Including common variables in the view</h2><p>If data is needed in more than one view (eg show the user’s name on every page when logged in), consider using <a href="https://laravel.com/docs/5.6/views#view-composers">view composers</a> to retrieve this data rather than fetching them in the controller. That way you’re not having to repeat that logic in more than one place.</p><h2 id="formatting-content-for-display">Formatting content for display</h2><p>Logically this belongs in the view layer, so you should <a href="/blog/2018/01/09/creating-laravel-helpers/">write a helper</a> to handle things like formatting dates. For more complex stuff, such as formatting HTML, you should be doing this in Blade (or another templating system, if you’re using one) - for instance, when generating an HTML table, you should consider <a href="https://laravel.com/docs/5.6/blade#rendering-views-for-collections">using a view partial</a> to loop through them. For particularly tricky functionality, you have the option of <a href="https://laravel.com/docs/5.6/blade#extending-blade">writing a custom Blade directive</a>.</p><p>The same applies for rendering other content - for rendering JSON you should consider using <a href="https://laravel.com/docs/5.6/eloquent-resources">API resources</a> or <a href="https://fractal.thephpleague.com/">Fractal</a> to get any non-trivial logic for your API responses out of the controller. Blade templates can also work for non-HTML content such as XML.</p><h2 id="anything-else-">Anything else…</h2><p>These examples are largely to get you started, and there will be occasions where something doesn’t fall into any of the above categories. However, the same principle applies. Your controllers should stick to just receiving requests and sending responses, and anything else should normally be deferred to other classes.</p><p>Fat controllers make developer’s lives very difficult, and if you want your code base to be easily maintainable, you should be willing to refactor them ruthlessly. Any functionality you can pull out of the controller becomes easier to reuse and test, and as long as you name your classes and methods sensibly, they’re easier to understand.</p><ul class="categorylist"><li><a href="/blog/categories/php/">php</a></li><li><a href="/blog/categories/laravel/">laravel</a></li></ul><div class="addthis_sharing_toolbox"></div><section class="comments"><div id="disqus_thread"></div><script>var disqus_config = function () {
                        this.page.url = "https://matthewdaly.co.uk/blog/2018/02/18/put-your-laravel-controllers-on-a-diet/";
                        this.page.identifier = "https://matthewdaly.co.uk/blog/2018/02/18/put-your-laravel-controllers-on-a-diet/";
                     };
                  (function() { // DON'T EDIT BELOW THIS LINE
                     var d = document, s = d.createElement('script');
                     s.src = 'https://matthewdaly.disqus.com/embed.js';
                     s.setAttribute('data-timestamp', +new Date());
                     (d.head || d.body).appendChild(s);
                  })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></section></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2018/02/25/unit-testing-your-laravel-controllers/">Unit Testing Your Laravel Controllers</a></p><p><a href="/blog/2018/02/18/put-your-laravel-controllers-on-a-diet/">Put Your Laravel Controllers on a Diet</a></p><p><a href="/blog/2018/02/04/using-lando-as-an-alternative-to-vagrant/">Using Lando As An Alternative to Vagrant</a></p><p><a href="/blog/2018/01/29/how-i-deploy-laravel-apps/">How I Deploy Laravel Apps</a></p><p><a href="/blog/2018/01/28/why-the-speed-of-your-mvc-framework-is-usually-a-red-herring/">Why the Speed of Your MVC Framework Is Usually a Red Herring</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="links"><h2>Links</h2><a href="https://github.com/matthewbdaly" rel="me">GitHub</a> <a href="https://twitter.com/MattBD" rel="me">Twitter</a> <a href="http://stackoverflow.com/users/63717/matthew-daly">Stack Overflow</a></section></div></div><div class="row"><div class="col-md-12"><ul class="pager"><li><a href="/blog/2018/02/04/using-lando-as-an-alternative-to-vagrant/"><span class="glyphicon glyphicon-chevron-left"></span> Using Lando As An Alternative to Vagrant</a></li><li><a href="/blog/2018/02/25/unit-testing-your-laravel-controllers/">Unit Testing Your Laravel Controllers <span class="glyphicon glyphicon-chevron-right"></span></a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2018.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script><script id="dsq-count-scr" src="//matthewdaly.disqus.com/count.js" async></script></body></html>