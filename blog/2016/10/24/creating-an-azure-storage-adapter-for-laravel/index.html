<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="theme-color" content="#252525"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0"><meta name="description" content="I&#x27;m a web developer in Norfolk. This is my blog..."><meta name="keywords" content="php,laravel"><link rel="amphtml" href="http://matthewdaly.co.uk/blog/2016/10/24/creating-an-azure-storage-adapter-for-laravel/amp/"><link rel="canonical" href="http://matthewdaly.co.uk/blog/2016/10/24/creating-an-azure-storage-adapter-for-laravel/"><link href="/favicon.ico" rel="icon"><link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/manifest.json"><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" type="text/css" href="/static/css/style.min.css" media="all"><link rel="alternate" type="application/rss+xml" title="Matthew Daly&#x27;s Blog - feed" href="/rss.xml"><link rel="alternate" type="application/atom+xml" title="Matthew Daly&#x27;s Blog - feed" href="/atom.xml"><title>Creating An Azure Storage Adapter for Laravel - Matthew Daly&#x27;s Blog</title></head><body><script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=MattBD" async="async"></script><header><div class="container headercontainer"><div class="jumbotron"><h1><a href="/">Matthew Daly&#x27;s Blog</a></h1><h2>I&#x27;m a web developer in Norfolk. This is my blog...</h2></div></div><div class="container headercontainer"><nav class="navbar navbar-inverse navbar-static-top"><div class="navbar-header"><button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-nav"><span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button><div class="collapse navbar-collapse" id="header-nav"><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href="/blog/archives/">Archives</a></li><li><a href="/about/">About</a></li><li><a href="/rss.xml">RSS</a></li></ul><form action="https://www.google.com/search" method="GET" name="searchForm" id="searchForm" enctype="application/x-www-form-urlencoded" class="navbar-form navbar-right"><div class="form-group"><input type="hidden" id="sitesearch" value="matthewdaly.co.uk"> <input id="search" type="search" name="q" results="0" placeholder="Search..." maxlength="200" autocomplete="off" class="form-control"><ul class="searchresults"></ul></div></form></div></div></nav></div></header><div id="mainbody" class="container"><div class="row"><div class="col-md-8"><article class="post"><p class="date">24th October 2016 12:25 am</p><h1>Creating An Azure Storage Adapter for Laravel</h1><p>About a year ago I was working on my first non-trivial Laravel application. The client had, for their own reasons, wanted to use Microsoft’s Azure platform, particularly for its blob storage functionality, which is somewhat comparable to Amazon S3. Now, Laravel has the excellent <code>Storage</code> facade that allows consistent access to both local files and those stored on various file hosting services, which is built on top of <a href="https://flysystem.thephpleague.com/">Flysystem</a>. Flysystem has an Azure driver, but the Laravel storage doesn’t include support for it, so at the time I resigned myself to using Flysystem directly, which wasn’t actually that bad, but not ideal.</p><p>A few days ago I stumbled across <a href="https://laravel.com/docs/5.1/filesystem#custom-filesystems">this section of the Laravel documentation</a>, which had me kicking myself. It’s actually trivially easy to implement a custom filesystem for Laravel if it already has a Flysystem adapter, as demonstrated in their Dropbox implementation in the docs. Using this as a guide, I was able to produce the following service provider for using Azure as a storage backend very quickly:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td><span class="hljs-meta">&lt;?php</span></td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td><span class="hljs-keyword">namespace</span> <span class="hljs-title">App</span>\<span class="hljs-title">Providers</span>;</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Storage</span>;</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">League</span>\<span class="hljs-title">Flysystem</span>\<span class="hljs-title">Filesystem</span>;</td></tr><tr><td class="linenos" data-pseudo-content="7"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">Illuminate</span>\<span class="hljs-title">Support</span>\<span class="hljs-title">ServiceProvider</span>;</td></tr><tr><td class="linenos" data-pseudo-content="8"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">League</span>\<span class="hljs-title">Flysystem</span>\<span class="hljs-title">Azure</span>\<span class="hljs-title">AzureAdapter</span>;</td></tr><tr><td class="linenos" data-pseudo-content="9"></td><td><span class="hljs-keyword">use</span> <span class="hljs-title">WindowsAzure</span>\<span class="hljs-title">Common</span>\<span class="hljs-title">ServicesBuilder</span>;</td></tr><tr><td class="linenos" data-pseudo-content="10"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="11"></td><td><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AzureStorageServiceProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">ServiceProvider</span></span></td></tr><tr><td class="linenos" data-pseudo-content="12"></td><td>{</td></tr><tr><td class="linenos" data-pseudo-content="13"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="14"></td><td>     * Perform post-registration booting of services.</td></tr><tr><td class="linenos" data-pseudo-content="15"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="16"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="17"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="18"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">boot</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="19"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="20"></td><td>        Storage::extend(<span class="hljs-string">'azure'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">($app, $config)</span> </span>{</td></tr><tr><td class="linenos" data-pseudo-content="21"></td><td>            $endpoint = sprintf(</td></tr><tr><td class="linenos" data-pseudo-content="22"></td><td>                <span class="hljs-string">'DefaultEndpointsProtocol=https;AccountName=%s;AccountKey=%s'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="23"></td><td>                $config[<span class="hljs-string">'name'</span>],</td></tr><tr><td class="linenos" data-pseudo-content="24"></td><td>                $config[<span class="hljs-string">'key'</span>]</td></tr><tr><td class="linenos" data-pseudo-content="25"></td><td>            );</td></tr><tr><td class="linenos" data-pseudo-content="26"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="27"></td><td>            $blobRestProxy = ServicesBuilder::getInstance()-&gt;createBlobService($endpoint);</td></tr><tr><td class="linenos" data-pseudo-content="28"></td><td>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Filesystem(<span class="hljs-keyword">new</span> AzureAdapter($blobRestProxy, $config[<span class="hljs-string">'container'</span>]));</td></tr><tr><td class="linenos" data-pseudo-content="29"></td><td>        });</td></tr><tr><td class="linenos" data-pseudo-content="30"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="31"></td><td></td></tr><tr><td class="linenos" data-pseudo-content="32"></td><td>    <span class="hljs-comment">/**</span></td></tr><tr><td class="linenos" data-pseudo-content="33"></td><td>     * Register bindings in the container.</td></tr><tr><td class="linenos" data-pseudo-content="34"></td><td>     *</td></tr><tr><td class="linenos" data-pseudo-content="35"></td><td>     * <span class="hljs-doctag">@return</span> void</td></tr><tr><td class="linenos" data-pseudo-content="36"></td><td>     */</td></tr><tr><td class="linenos" data-pseudo-content="37"></td><td>    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">register</span><span class="hljs-params">()</span></span></td></tr><tr><td class="linenos" data-pseudo-content="38"></td><td>    {</td></tr><tr><td class="linenos" data-pseudo-content="39"></td><td>        <span class="hljs-comment">//</span></td></tr><tr><td class="linenos" data-pseudo-content="40"></td><td>    }</td></tr><tr><td class="linenos" data-pseudo-content="41"></td><td>}</td></tr></table></code></pre><p>This should be saved as <code>app/Providers/AzureStorageServiceProvider.php</code>. You also need to add this to the list of service providers in <code>config/app.php</code>:</p><pre><code class="hljs lang-php singleline"><table>        App\Providers\AzureStorageServiceProvider::class,</table></code></pre><p>And add this to <code>config/filesystems.php</code>:</p><pre><code class="hljs lang-php"><table><tr><td class="linenos" data-pseudo-content="1"></td><td>        <span class="hljs-string">'azure'</span> =&gt; [</td></tr><tr><td class="linenos" data-pseudo-content="2"></td><td>            <span class="hljs-string">'driver'</span>    =&gt; <span class="hljs-string">'azure'</span>,</td></tr><tr><td class="linenos" data-pseudo-content="3"></td><td>            <span class="hljs-string">'name'</span>      =&gt; env(<span class="hljs-string">'STORAGE_NAME'</span>),</td></tr><tr><td class="linenos" data-pseudo-content="4"></td><td>            <span class="hljs-string">'key'</span>       =&gt; env(<span class="hljs-string">'STORAGE_KEY'</span>),</td></tr><tr><td class="linenos" data-pseudo-content="5"></td><td>            <span class="hljs-string">'container'</span> =&gt; env(<span class="hljs-string">'STORAGE_CONTAINER'</span>),</td></tr><tr><td class="linenos" data-pseudo-content="6"></td><td>        ],</td></tr></table></code></pre><p>I like to also set my storage backend using environment variables in this file, as in this example:</p><pre><code class="hljs lang-php singleline"><table>    <span class="hljs-string">'default'</span> =&gt; env(<span class="hljs-string">'STORAGE_BACKEND'</span>, <span class="hljs-string">'local'</span>),</table></code></pre><p>That way we can easily set a different backend for testing, development and production so we don’t upload files when running PHPUnit. You can also keep your other config settings in your <code>.env</code> file, which is always a better idea than keeping it under version control. You also need to install the <code>microsoft/windowsazure</code> and <code>league/flysystem-azure</code> packages via Composer for this to work.</p><p>As I’ve since changed jobs it’s unlikely I’ll ever actually use this Azure integration in production - it’s not a service I’d choose of my own accord to use. However, since it’s so straightforward to implement an adapter like this I imagine I may be doing something similar - I’m currently working on a web app that uses MongoDB for some of its data and currently stores files locally, so it might make sense to create a GridFS integration along similar lines. It may also be useful for someone else, so feel free to use it if you wish.</p><ul class="categorylist"><li><a href="/blog/categories/php/">php</a></li><li><a href="/blog/categories/laravel/">laravel</a></li></ul><div class="addthis_sharing_toolbox"></div><section class="comments"><div id="disqus_thread"></div><script type="text/javascript">window.disqus_identifier="http://matthewdaly.co.uk/blog/2016/10/24/creating-an-azure-storage-adapter-for-laravel/";
                    window.disqus_url="http://matthewdaly.co.uk/blog/2016/10/24/creating-an-azure-storage-adapter-for-laravel/";
                    window.disqus_title="Creating An Azure Storage Adapter for Laravel";</script><script type="text/javascript" src="http://disqus.com/forums/matthewdaly/embed.js"></script><noscript><a href="http://matthewdaly.disqus.com/?url=ref">View the discussion thread.</a></noscript></section></article></div><div class="col-md-4"><h1>Recent Posts</h1><p><a href="/blog/2016/11/26/easy-static-asset-versioning-in-php/">Easy Static Asset Versioning in PHP</a></p><p><a href="/blog/2016/11/13/building-a-phonegap-app-with-laravel-and-angular-part-4/">Building a Phonegap App With Laravel and Angular - Part 4</a></p><p><a href="/blog/2016/10/24/creating-an-azure-storage-adapter-for-laravel/">Creating An Azure Storage Adapter for Laravel</a></p><p><a href="/blog/2016/10/16/building-a-phonegap-app-with-laravel-and-angular-part-3/">Building a Phonegap App With Laravel and Angular - Part 3</a></p><p><a href="/blog/2016/09/18/building-a-phonegap-app-with-laravel-and-angular-part-2/">Building a Phonegap App With Laravel and Angular - Part 2</a></p><section><h2>About me</h2><p>I'm a web and mobile app developer based in Norfolk. My skillset includes Python, PHP and Javascript, and I have extensive experience working with CodeIgniter, Laravel, Django, Phonegap and Angular.js.</p></section><section id="github-profile"></section><h4>My GitHub repositories</h4><ul id="github-repos"><li>Loading repositories...</li></ul></div></div><div class="row"><div class="col-md-12"><ul class="pager"><li><a href="/blog/2016/10/16/building-a-phonegap-app-with-laravel-and-angular-part-3/"><span class="glyphicon glyphicon-chevron-left"></span> Building a Phonegap App With Laravel and Angular - Part 3</a></li><li><a href="/blog/2016/11/13/building-a-phonegap-app-with-laravel-and-angular-part-4/">Building a Phonegap App With Laravel and Angular - Part 4 <span class="glyphicon glyphicon-chevron-right"></span></a></li></ul></div></div></div><footer><div class="container footercontainer"><div class="col-md-12"><p class="copyright">Copyright &copy; Matthew Daly 2016.</p></div></div></footer><script type="text/javascript" src="/static/js/all.min.js"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-17043630-1');ga('send','pageview');</script></body></html>